{{ $GenContainer := where $ "ID" .Docker.CurrentContainerID | first }}
<system>
  rpc_endpoint 127.0.0.1:24220
</system>

<source>
@type forward
</source>

<filter docker.core.**>
@type parser
format json
key_name log
time_format %Y-%m-%dT%H:%M:%S%z
</filter>

<filter docker.nginx>
@type parser
format json
key_name log
time_format %Y-%m-%dT%H:%M:%S%z
</filter>

{{range $key, $CurrentContainer := whereLabelExists . "fluentd.tag"}}
    {{$service := index $CurrentContainer.Labels "fluentd.tag"}}
    {{$project := index $CurrentContainer.Labels "com.docker.compose.project"}}
    {{$isCoreService := hasPrefix "core" (print $service)}}

    <match docker.{{$service}}>
        @type copy
        deep_copy true
        <store>
            @type s3
            @log_level debug
            aws_key_id {{$GenContainer.Env.AWS_KEY_ID}}
            aws_sec_key {{$GenContainer.Env.AWS_SECRET_KEY}}
            s3_bucket {{$project}}
            s3_region {{$GenContainer.Env.AWS_REGION}}
            path {{replace $service "." "/" -1}}/{{$CurrentContainer.Name}}/
            buffer_path /fluentd/logs/{{$CurrentContainer.Name}}/

            store_as json
            format json
            include_time_key true
            time_key time
            include_tag_key true

            time_slice_format %Y%m%d%H
            time_slice_wait 1m

            utc
        </store>

         <store>
             @type cloudwatch_logs
             @log_level debug
             region {{$GenContainer.Env.AWS_REGION}}
             aws_key_id {{$GenContainer.Env.AWS_KEY_ID}}
             aws_sec_key {{$GenContainer.Env.AWS_SECRET_KEY}}
             log_group_name {{$project}}
             log_stream_name {{$service}}
             auto_create_stream true
             {{if or $isCoreService (eq $service "nginx")}}#{{end}}message_keys log
         </store>

         {{if index $CurrentContainer.Labels "fluentd.influxdb.tags"}}
         <store>
             @type influxdb
             @log_level debug
             host influxdb
             port 8086
             dbname {{$GenContainer.Env.INFLUXDB_DATABASE}}
             user {{$GenContainer.Env.INFLUXDB_ADMIN_USER}}
             password {{$GenContainer.Env.INFLUXDB_ADMIN_PASSWORD}}
             time_precision {{index .CurrentContainer.Labels "fluentd.influxdb.precision"}}
             tag_keys {{index $CurrentContainer.Labels "fluentd.influxdb.tags"}}
          </store>
         {{end}}

         {{if $CurrentContainer.Env.FLUENTD_STDOUT}}
         <store>
            @type stdout
         </store>
         {{end}}
    </match>
{{end}}

